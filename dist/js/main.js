var DrillDownMenu=function(a,b){var c=_.extend({},this.DEFAULTS,b);this.items=new DrillDownMenuItem,this.view=new DrillDownMenuView({items:this.items,iconMappings:c.iconMappings,customizedEvents:c.events}).render(),this.initialize(a)};DrillDownMenu.DEFAULTS={iconMappings:function(){return""}},DrillDownMenu.prototype.initialize=function(a){_.isFunction(a)&&(this.fetchChildren=a,a=this.fetchChildren()),a.forEach(function(a){this.addMenuItem(this.items,a)},this)},DrillDownMenu.prototype.getView=function(){return this.view},DrillDownMenu.prototype.setItems=function(a){this.items.reset(),this.initialize(a)},DrillDownMenu.prototype.addMenuItem=function(a,b){var c=new DrillDownMenuItem({title:b.title,type:b.type,hasChild:b.hasChild,children:b.children,fetchChildren:this.fetchChildren});a.add(c),b.hasOwnProperty("children")&&b.children&&b.children.forEach(function(a){this.addMenuItem(c,a)},this)};var DrillDownMenuItem=Backbone.Model.extend({initialize:function(a){a&&(this.title=a.title,this.href=a.href,this.hasChild=a.hasChild,this.fetchChildren=a.fetchChildren)},add:function(a){void 0===this.collection&&(this.collection=[]),this.collection.push(a),this.listenTo(a,"open",this.propagateOpenEvent),this.trigger("add",a)},reset:function(){this.collection=[],this.trigger("reset")},open:function(){this.hasChild&&void 0===this.collection&&this.fetchChildren(this.title).map(function(a){return new DrillDownMenuItem(a)}).forEach(this.add,this),this.trigger("open",this)},propagateOpenEvent:function(a){this.trigger("open",a)}}),DrillDownMenuItemView=Backbone.View.extend({tagName:"li",template:_.template('<a href="<%= href %>"><%= icon %><%= title %></a>'),events:{"click a":"onClick"},initialize:function(a){this.iconMappings=a.iconMappings,this.customizedEvents=a.customizedEvents,this.listenTo(this.model,"add",this.addItem),this.listenTo(this.model,"open",this.open)},render:function(){return this.$el.html(this.template({title:this.model.title,href:this.model.href,icon:this.iconMappings(this.model.type)})),this.delegateCustomizedEvents(),this},appendList:function(){this.hasMenuItems()&&(this.$list=$("<ul></ul>"),this.$list.addClass("drilldown-menu"),this.$el.append(this.$list))},addItem:function(a){void 0===this.$list&&this.appendList(),this.$list.append(new DrillDownMenuItemView({model:a,iconMappings:this.iconMappings,customizedEvents:this.customizedEvents}).render().el),this.delegateCustomizedEvents()},onClick:function(a){this.hasMenuItems()&&(a.stopPropagation(),this.model.open())},open:function(){this.$el.parent().addClass("drilldown-menu-hide")},hasMenuItems:function(){return this.model.hasChild||void 0!==this.model.collection},delegateCustomizedEvents:function(){var a=/(\w+)\s+(\w+)?:(\w+)/;for(var b in this.customizedEvents){var c=b.match(a);if(c){var d=c[1],e=c[2],f=c[3];if(!e||e==this.model.title)switch(f){case"child":this.hasMenuItems()||this.$el.on(d,this.customizedEvents[b]);break;case"parent":this.hasMenuItems()&&this.$el.on(d,this.customizedEvents[b])}}}}}),DrillDownMenuView=Backbone.View.extend({className:"drilldown drilldown-hide",template:_.template('<button class="drilldown-menu-return btn btn-default"><span class="glyphicon glyphicon-backward"></span></button><button class="drilldown-menu-close btn btn-default"><span class="glyphicon glyphicon-remove"></span></button><ul class="drilldown-menu" />'),events:{"click .drilldown-menu-return":"return","click .drilldown-menu-close":"close"},defaults:_.extend({},{headerHeight:32,itemViewHeight:41,events:{}},DrillDownMenu.DEFAULTS),initialize:function(a){this.itemViews=[],this.items=a.items,this.iconMappings=a.iconMappings||this.defaults.iconMappings,this.customizedEvents=a.customizedEvents||this.defaults.events,this.listenTo(this.items,"add",this.addOne),this.listenTo(this.items,"reset",this.render),this.listenTo(this.items,"open",this.delayedResize)},render:function(){return this.$el.html(this.template()),void 0!==this.items.collection&&this.items.collection.forEach(function(a){this.createAndAppendItemView(a)},this),this},addOne:function(a){this.createAndAppendItemView(a),this.resize(this.items)},createAndAppendItemView:function(a){var b=new DrillDownMenuItemView({model:a,iconMappings:this.iconMappings,customizedEvents:this.customizedEvents});this.itemViews.push(b),this.getList().append(b.render().el)},getList:function(){return this.$("> ul")},getItemView:function(a){return this.itemViews[a]},getReturnBtn:function(){return this.$(".drilldown-menu-return")},getCloseBtn:function(){return this.$(".drilldown-menu-close")},"return":function(){this.$(".drilldown-menu-hide").removeClass("drilldown-menu-hide"),this.resize(this.items)},close:function(){this.$el.addClass("drilldown-hide")},open:function(){this.$el.removeClass("drilldown-hide")},resize:function(a){var b=a.collection?a.collection.length:0;this.$el.height(this.defaults.headerHeight+b*this.defaults.itemViewHeight)},delayedResize:function(a){var b=this;setTimeout(function(){b.resize(a)},500)}});+function(a){var b=function(a,b){this.$input=a;var c=new DrillDownMenu(b.items,b.options);this.appendMenuToInput(c,a).registerClickEvent(a,c).registerKeyupEvent(a,c,b).registerBlurEvent(c)};b.DEFAULTS=a.extend({},DrillDownMenu.DEFAULTS,{items:[],isValid:function(a,b){return new RegExp(b,"i").test(a.title)}}),b.prototype.appendMenuToInput=function(a,b){return b.after(a.getView().$el),this},b.prototype.registerClickEvent=function(a,b){return a.on("click.drilldown",function(a){a.stopPropagation(),b.getView().open()}),this},b.prototype.registerKeyupEvent=function(a,b,c){var d=this;return a.keyup(function(){var a=[],e=function(b){a.push(b)};d.traverseItems(c.items,c.isValid,e),b.setItems(a)}),this},b.prototype.registerBlurEvent=function(b){a(document).on("click.drilldown",function(){b.getView().close()})},b.prototype.traverseItems=function(a,b,c){var d=this;a.forEach(function(a){a.hasOwnProperty("children")?d.traverseItems(a.children,b,c):b(a,d.getInputValue())&&c(a)})},b.prototype.getInputValue=function(){return this.$input.val()},a.fn.drilldown=function(c){var d=a.extend({},b.DEFAULTS,c);return this.each(function(){{var c=a(this);new b(c,d)}})}}(jQuery);